<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>會員管理 - 光影之門</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/sb-admin-2.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/2.2.2/css/dataTables.bootstrap5.min.css" rel="stylesheet">
</head>
<body id="page-top">
  <div id="wrapper">
    <th:block th:replace="fragments/empSidebar :: sidebar"></th:block>
    <div id="content-wrapper" class="d-flex flex-column">
      <div id="content">
        <th:block th:replace="fragments/empTopbar :: topbar"></th:block>

        <div class="container-fluid mt-4">
          <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h4 text-gray-800">會員管理系統</h1>
            <div class="d-flex gap-2">
              <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#registerModal">
                <i class="fas fa-user-plus"></i> 新增會員
              </button>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-md-3">
                  <select id="searchType" class="form-select">
                    <option value="" selected>請選擇搜尋的功能</option>
                    <option value="name">姓名模糊搜尋</option>
                    <option value="email">信箱模糊搜尋</option>
                    <option value="phone">手機號碼模糊搜尋</option>
                  </select>
                </div>
                <div class="col-md-5">
                  <input type="text" id="keyword" class="form-control" placeholder="請輸入關鍵字">
                </div>
                <div class="col-md-2">
                  <button class="btn btn-primary" id="searchBtn">搜尋</button>
                </div>
              </div>
              <div class="table-responsive">
                <table id="memberTable" class="table table-bordered table-striped">
                  <thead class="table-light">
                    <tr>
                      <th>會員ID</th>
                      <th>姓名</th>
                      <th>性別</th>
                      <th>身分證</th>
                      <th>生日</th>
                      <th>Email</th>
                      <th>手機</th>
                      <th>新信箱</th>
                      <th>是否驗證</th>
                      <th>驗證碼</th>
                      <th>註冊時間</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
      <th:block th:replace="fragments/empFooter :: footer"></th:block>
    </div>
  </div>

  <a class="scroll-to-top rounded" href="#page-top"><i class="fas fa-angle-up"></i></a>

  <th:block th:replace="member/memberModalCRUD :: registerModal"></th:block>
  <th:block th:replace="member/memberModalCRUD :: editModal"></th:block>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/2.2.2/js/dataTables.bootstrap5.min.js"></script>
  <script src="/js/sb-admin-2.min.js"></script>

	<script th:inline="javascript">
    $(function () {
      const table = $('#memberTable').DataTable({
        ajax: { url: '/memberManagerApi/list', dataSrc: '' },
        columns: [
          { data: 'memberId' },
          { data: 'name' },
          { data: 'gender' },
          { data: 'nationalId' },
          { data: 'dateOfBirth' },
          { data: 'email' },
          { data: 'phoneNumber' },
          { data: 'newEmail' },
          { data: 'verification' },
          { data: 'verificationCode' },
          { data: 'createTime', render: d => d.replace('T', ' ') },
          {
            data: null,
            orderable: false,
            searchable: false,
            className: 'text-center',
            render: function (row) {
              return `
              <div class="d-flex justify-content-center gap-1">
                <button class="btn btn-warning btn-sm edit-btn" data-id="${row.memberId}">
                  <i class="fas fa-edit"></i>修改
                </button>
                <button class="btn btn-danger btn-sm delete-btn" data-id="${row.memberId}">
                  <i class="fas fa-trash-alt"></i>刪除
                </button>
                <button class="btn btn-info btn-sm verify-btn" data-id="${row.memberId}">
                  <i class="fas fa-envelope"></i>寄送驗證信
                </button>
                </div>`;
            }
          }
        ],
        columnDefs: [{ targets: '_all', className: 'text-left' }],
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json' }
      });

      $('#searchBtn').click(() => {
        const type = $('#searchType').val();
        const keyword = $('#keyword').val();
        if (!type || !keyword) return;
        $.get('/memberManagerApi/search', { type, keyword }, data => {
          table.clear().rows.add(data).draw();
        });
      });
    });
    
    $('.register-form').submit(function (e) {
  e.preventDefault();

  const formData = $(this).serialize();

  $.ajax({
    url: '/memberManagerApi/register',
    type: 'POST',
    data: formData,
    success: function (res) {
      if (res.status === 'success') {
        Swal.fire('註冊成功', `新增 <b>${res.name}</b> 成功`, 'success').then(() => {
          $('#registerModal').modal('hide');
          $('#memberTable').DataTable().ajax.reload();
          $('.register-form')[0].reset(); // 清空表單
        });
      } else {
        Swal.fire('註冊失敗', res.message || '請稍後再試', 'error');
      }
    },
    error: function () {
      Swal.fire('伺服器錯誤', '請稍後再試或聯絡客服', 'error');
    }
  });
});
    
    
    
    
   $('#memberTable').on('click', '.edit-btn', function () {
  const memberId = $(this).data('id');

  $.ajax({
    url: `/memberManagerApi/find/${memberId}`,
    type: 'GET',
    success: function (member) {
      const $modal = $('#editModal');
      $modal.find('input[name="memberId"]').val(member.memberId);
      $modal.find('input[name="name"]').val(member.name);
      $modal.find('input[name="email"]').val(member.email);
      $modal.find('input[name="phoneNumber"]').val(member.phoneNumber);

      // 格式化日期（避免包含T的情況）
      const formattedDate = member.dateOfBirth?.split('T')[0] || '';
      $modal.find('input[name="dateOfBirth"]').val(formattedDate);

      $modal.find('input[name="gender"][value="' + member.gender + '"]').prop('checked', true);

      const modal = new bootstrap.Modal(document.getElementById('editModal'));
      modal.show();
    },
    error: function () {
      Swal.fire('查詢失敗', '請稍後再試', 'error');
    }
  });
});

// 提交編輯資料
$('#edit-form').submit(function (e) {
  e.preventDefault();

  const $modal = $('#editModal');
  const data = {
    memberId: $modal.find('input[name="memberId"]').val(),
    name: $modal.find('input[name="name"]').val(),
    email: $modal.find('input[name="email"]').val(),
    phoneNumber: $modal.find('input[name="phoneNumber"]').val(),
    dateOfBirth: $modal.find('input[name="dateOfBirth"]').val(),
    gender: $modal.find('input[name="gender"]:checked').val()
  };

  $.ajax({
    url: '/memberManagerApi/update',
    type: 'PUT',
    contentType: 'application/json',
    data: JSON.stringify(data),
    success: function (res) {
      if (res.status === 'success') {
        Swal.fire('修改成功', '', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        $('#memberTable').DataTable().ajax.reload();
      } else {
        Swal.fire('修改失敗', res.message || '', 'error');
      }
    },
    error: function () {
      Swal.fire('伺服器錯誤', '', 'error');
    }
  });
});
    $('#memberTable').on('click', '.delete-btn', function () {
 	 const memberId = $(this).data('id');
  	Swal.fire({
    title: '確定要刪除這位會員嗎？',
    text: `會員ID: ${memberId}`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: '刪除',
    cancelButtonText: '取消'
  	}).then((result) => {
    if (result.isConfirmed) {
      $.ajax({
        url: `/memberManagerApi/delete/${memberId}`,
        type: 'DELETE',
        success: () => {
          Swal.fire('刪除成功', '', 'success');
          $('#memberTable').DataTable().ajax.reload();
        },
        error: () => {
          Swal.fire('刪除失敗', '請稍後再試', 'error');
        }
      });
    }
  });
});
    $('#memberTable').on('click', '.verify-btn', function () {
 	 const memberId = $(this).data('id');
	$.ajax({
    url: `/memberManagerApi/sendVerification/${memberId}`,
    type: 'POST',
    success: () => {
      Swal.fire('驗證信已寄出', '', 'success');
    },
    error: () => {
      Swal.fire('發送失敗', '請稍後再試', 'error');
    }
  });
});
    
  </script>

</body>
</html>